#!/usr/bin/env ruby
require 'newrepo'
require 'colorize'
require 'optparse'

options = {}

nr = OptionParser.new do |opt|
  info = Newrepo::Info.new
  opt.banner = info.describe
  opt.separator  ""
  opt.separator  "Usage: nr COMMAND1 COMMAND2[OPTIONS]"
  opt.separator  ""
  opt.separator  "Commands 1"
  opt.separator  "     public: Public Repo"
  opt.separator  "     private: Private Repo"
  opt.separator  ""
  opt.separator  ""
  opt.separator  "Command 2"
  opt.separator  "     Name of Repo"
  opt.separator  ""
  opt.separator  "Options"

  opt.on("-u", "--username", String, "your bitbucket username") do |username|
    options[:username] = username
  end

  opt.on("-p", "--password", String, "your password") do |password|
    options[:password] = password
  end

  opt.on("-n", "--name", String, "Repo name") do |name|
    options[:name] = name
  end

  opt.on("-l", "--language", String, "Repo language, i.e. Ruby, PHP, Javascript") do |language|
    options[:language] = language
  end

  opt.on("-h","--help","help") do
    puts nr
  end
end.parse!(ARGV)

def newrepo_path
  if ENV.include?('NEWREPO_PATH')
    nr_path = File.expand_path ENV['NEWREPO_PATH']
  else
    nr_path = File.expand_path "~/.newrepo"
  end

  if !File.exists?(nr_path)
    raise "ERROR: Your defined newrepo path (#{nr_path}) is missing".red
  end

  nr_path
rescue => e
    puts e
    abort
end

case ARGV[0]
when "public"
  permission = false
  puts "creating a public repo"
when "private"
  permission = true
  puts "creating a private repo"
else
  puts nr
end

# TODO add public or private options
Dir.chdir newrepo_path do
  info = Newrepo::Info.new
  cmd = "curl --user #{info.user}:#{info.pass} https://api.bitbucket.org/1.0/repositories/ --data \"name=#{ARGV[1]}\""
  puts cmd
  system cmd
end
